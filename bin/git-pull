#!/bin/bash

function lockit {
    function=$1
    lockfile=$2
    if ( set -o noclobber; echo "$$" > "$lockfile") 2> /dev/null; then
        trap 'rm -f "$lockfile"; exit $?' INT TERM EXIT

        $function

        rm -f "$lockfile"
        trap - INT TERM EXIT
    else 
        echo "Failed to acquire lockfile: $lockfile." 
        echo "Held by $(cat $lockfile)"
    fi
}

function main {
    cd ~/.nomad
    while true; do
        git pull
        sleep 3600
    done
}

exec &>>~/.nomad/.gitpull.log
lockit main ~/.nomad/.gitpull.lock
